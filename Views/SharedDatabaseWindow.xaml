<Window x:Class="AccesClientWPF.Views.SharedDatabaseWindow"
        x:Name="Root"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:AccesClientWPF.ViewModels"
        xmlns:conv="clr-namespace:AccesClientWPF.Converters"
        Title="Accès Client 1.4.2 / Partagé"
        Height="750" Width="1300"
        Background="#EAEDED"
        WindowStartupLocation="CenterScreen">

    <Window.Resources>
        <conv:FileTypeToIconConverter x:Key="FileTypeToIconConverter"/>
        <conv:StringToVisibilityConverter x:Key="StringToVisibilityConverter"/>
        <conv:NullOrEmptyToVisibilityConverter x:Key="NullOrEmptyToVisibilityConverter"/>
        <conv:DecryptPasswordConverter x:Key="DecryptPasswordConverter"/>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>

        <Style x:Key="RoundedButton" TargetType="Button">
            <Setter Property="Background" Value="#5DADE2"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" CornerRadius="8" Padding="10" BorderBrush="Transparent">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="CopyButton" TargetType="Button">
            <Setter Property="Background" Value="#F8F9F9"/>
            <Setter Property="BorderBrush" Value="#AEB6BF"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Padding" Value="2"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" CornerRadius="3"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                BorderBrush="{TemplateBinding BorderBrush}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="ContextMenuItemStyle" TargetType="MenuItem">
            <Setter Property="Padding" Value="8,4"/>
            <Setter Property="FontSize" Value="13"/>
        </Style>
    </Window.Resources>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="330"/>
        </Grid.ColumnDefinitions>

        <!-- Colonne gauche -->
        <DockPanel Grid.Column="0">
            <Border DockPanel.Dock="Left" Background="#34495E" Padding="10" CornerRadius="8">
                <DockPanel Width="253">
                    <TextBlock Text="Clients" FontSize="18" FontWeight="Bold" Foreground="White" Margin="5" DockPanel.Dock="Top"/>

                    <StackPanel DockPanel.Dock="Bottom">
                        <Button Content="Gérer les clients" Click="ManageClientsCommand_Click"
                                Margin="10,5" Height="45" Style="{StaticResource RoundedButton}"/>

                        <Button Content="Créer un nouveau fichier" Click="CreateNewDatabase_Click"
                                Margin="10,5" Height="45" Style="{StaticResource RoundedButton}"/>

                        <Button Content="Ouvrir base partagée" Click="OpenSharedDatabase_Click"
                                Margin="10,5" Height="45" Style="{StaticResource RoundedButton}"/>

                        <Button Content="Importer vers base principale" Click="ImportToMainDatabase_Click"
                                Margin="10,5" Height="45" Style="{StaticResource RoundedButton}"/>

                        <Button x:Name="BtnSave" Content="Sauvegarder" Click="SaveSharedDatabase_Click"
                                Margin="10,5" Height="45" Style="{StaticResource RoundedButton}"/>

                        <Button x:Name="BtnCancel" Content="Quitter (perdu si non sauvegardé)" Click="CancelAndClose_Click"
                                Margin="10,5,10,10" Height="45" Style="{StaticResource RoundedButton}"/>
                    </StackPanel>

                    <ListBox ItemsSource="{Binding Clients}" DisplayMemberPath="Name"
                             SelectedItem="{Binding SelectedClient, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                             Background="#D5DBDB" BorderThickness="0" Padding="5" Margin="0,5"
                             VerticalAlignment="Stretch" ScrollViewer.VerticalScrollBarVisibility="Auto"/>
                </DockPanel>
            </Border>

            <!-- contenu principal centre -->
            <ScrollViewer x:Name="MainScrollViewer"
                          VerticalScrollBarVisibility="Auto"
                          PreviewMouseWheel="MainScrollViewer_PreviewMouseWheel">
                <StackPanel>
                    <StackPanel Orientation="Horizontal" Margin="10">
                        <CheckBox Content="Activer le mode multi-moniteur" Margin="0,0,20,0"
                                  IsChecked="{Binding IsMultiMonitor, Mode=TwoWay}"/>
                        <CheckBox Content="Afficher les identifiants"
                                  IsChecked="{Binding ShowCredentials, Mode=TwoWay}"/>
                    </StackPanel>

                    <Border Background="#34495E" Margin="10,5,10,10" Padding="15,10" CornerRadius="8">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <TextBlock Grid.Column="0" Text="{Binding SelectedClient.Name}"
                                       FontSize="20" FontWeight="Bold" Foreground="White"
                                       HorizontalAlignment="Center"/>

                            <Button Grid.Column="1"
                                    Content="+ Ajouter"
                                    Click="AddButtonDirect_Click"
                                    Style="{StaticResource RoundedButton}"
                                    Background="#2ECC71"
                                    Foreground="White"
                                    Padding="8,3"
                                    Margin="5,0,10,0"/>
                        </Grid>
                    </Border>

                    <ListView Name="FileList"
                              ItemsSource="{Binding FilteredFiles}"
                              SelectedItem="{Binding SelectedFile, Mode=TwoWay}"
                              MouseDoubleClick="FileList_MouseDoubleClick"
                              Background="Transparent" BorderThickness="0"
                              ContextMenuOpening="FileList_ContextMenuOpening"
                              PreviewMouseRightButtonDown="FileList_PreviewMouseRightButtonDown"
                              ScrollViewer.VerticalScrollBarVisibility="Disabled">
                        <ListView.ContextMenu>
                            <ContextMenu>
                                <MenuItem Header="Ajouter un élément" Click="AddContextMenu_Click" Style="{StaticResource ContextMenuItemStyle}">
                                    <MenuItem.Icon>
                                        <Path Data="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"
                                              Fill="#2ECC71" Stretch="Uniform" Width="16" Height="16"/>
                                    </MenuItem.Icon>
                                </MenuItem>
                                <MenuItem Header="Modifier cet élément" Click="EditContextMenu_Click" Style="{StaticResource ContextMenuItemStyle}">
                                    <MenuItem.Icon>
                                        <Path Data="M20.71,7.04 18.37,4.7 16.96,3.29 3,17.25 3,21 6.75,21 20.71,7.04Z"
                                              Fill="#F39C12" Stretch="Uniform" Width="16" Height="16"/>
                                    </MenuItem.Icon>
                                </MenuItem>
                                <MenuItem Header="Tester l'élément" Click="TestConnectionMenu_Click" Style="{StaticResource ContextMenuItemStyle}">
                                    <MenuItem.Icon>
                                        <Ellipse Width="14" Height="14" Fill="#3498DB"/>
                                    </MenuItem.Icon>
                                </MenuItem>
                                <MenuItem Header="Supprimer cet élément" Click="DeleteContextMenu_Click" Style="{StaticResource ContextMenuItemStyle}">
                                    <MenuItem.Icon>
                                        <Path Data="M6,19 8,21 16,21 18,19 18,7 6,7 6,19Z M5,6 19,6 19,4 15.5,4 14.5,3 9.5,3 8.5,4 5,4Z"
                                              Fill="#E74C3C" Stretch="Uniform" Width="16" Height="16"/>
                                    </MenuItem.Icon>
                                </MenuItem>
                            </ContextMenu>
                        </ListView.ContextMenu>

                        <ListView.ItemTemplate>
                            <DataTemplate>
                                <Border CornerRadius="10" Background="#FDFEFE" Padding="10" Margin="5">
                                    <StackPanel>
                                        <Grid Width="600">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="80"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>

                                            <Border Grid.Column="0" Background="#EAEDED" Padding="5" CornerRadius="8" Margin="0,0,15,0" Width="70" Height="70">
                                                <Image Width="56" Height="56" RenderOptions.BitmapScalingMode="HighQuality">
                                                    <Image.Source>
                                                        <Binding Path="." Converter="{StaticResource FileTypeToIconConverter}"/>
                                                    </Image.Source>
                                                </Image>
                                            </Border>

                                            <TextBlock Grid.Column="1" Text="{Binding Name}" VerticalAlignment="Center"
                                                       FontSize="16" FontWeight="Bold" Foreground="#2C3E50"/>

                                            <TextBlock Grid.Column="2" Text="{Binding Type}" VerticalAlignment="Center"
                                                       FontSize="13" Foreground="#7F8C8D" Margin="10,0,0,0"/>
                                        </Grid>

                                        <!-- détails AnyDesk -->
                                        <Grid Visibility="{Binding Type, Converter={StaticResource StringToVisibilityConverter}, ConverterParameter=AnyDesk}"
                                              Margin="80,5,0,0">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>

                                            <StackPanel Grid.Column="0" Orientation="Horizontal"
                                                        Visibility="{Binding WindowsUsername, Converter={StaticResource NullOrEmptyToVisibilityConverter}}">
                                                <TextBlock Text="Utilisateur Windows:" VerticalAlignment="Center"
                                                           FontSize="12" FontWeight="Bold" Foreground="#34495E"/>
                                                <TextBlock Text="{Binding WindowsUsername}" VerticalAlignment="Center"
                                                           FontSize="12" Foreground="#34495E" Margin="5,0,5,0"
                                                           Visibility="{Binding DataContext.ShowCredentials, RelativeSource={RelativeSource AncestorType=Window}, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                                <Button Content="📋" Width="25" Height="25" Margin="2"
                                                        ToolTip="Copier le nom d'utilisateur"
                                                        Click="CopyWindowsUsername_Click"
                                                        Tag="{Binding WindowsUsername}"
                                                        Style="{StaticResource CopyButton}"/>
                                            </StackPanel>

                                            <StackPanel Grid.Column="2" Orientation="Horizontal" Margin="15,0,0,0"
                                                        Visibility="{Binding WindowsPassword, Converter={StaticResource NullOrEmptyToVisibilityConverter}}">
                                                <TextBlock Text="Mot de passe Windows:" VerticalAlignment="Center"
                                                           FontSize="12" FontWeight="Bold" Foreground="#34495E"/>
                                                <TextBlock VerticalAlignment="Center"
                                                           FontSize="12" Foreground="#34495E" Margin="5,0,5,0"
                                                           Visibility="{Binding DataContext.ShowCredentials, RelativeSource={RelativeSource AncestorType=Window}, Converter={StaticResource BooleanToVisibilityConverter}}">
                                                    <Run Text="{Binding WindowsPassword, Converter={StaticResource DecryptPasswordConverter}, Mode=OneWay}"/>
                                                </TextBlock>
                                                <Button Content="📋" Width="25" Height="25" Margin="5,0,0,0"
                                                        ToolTip="Copier le mot de passe"
                                                        Click="CopyWindowsPassword_Click"
                                                        Tag="{Binding}"
                                                        Style="{StaticResource CopyButton}"/>
                                            </StackPanel>
                                        </Grid>
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                    </ListView>
                </StackPanel>
            </ScrollViewer>
        </DockPanel>

        <!-- Colonne droite — mots de passe supplémentaires (toujours visible) -->
        <Border Grid.Column="1"
        x:Name="RightPanel"
        Background="#FDF6E3"
        BorderBrush="#D5DBDB"
        BorderThickness="1"
        CornerRadius="12"
        Padding="20"
        Margin="15,20,15,20">

            <DockPanel LastChildFill="True">

                <!-- En-tête -->
                <DockPanel DockPanel.Dock="Top" LastChildFill="True" Margin="0,0,0,12">
                    <TextBlock Text="Mots de passe supplémentaires"
                       FontSize="13" FontWeight="Bold" Foreground="#34495E"
                       VerticalAlignment="Center"
                       Margin="0,0,12,0"
                       TextWrapping="NoWrap"
                       TextTrimming="CharacterEllipsis"/>

                    <Button Content="+ Ajout"
                    DockPanel.Dock="Right"
                    Padding="5,4"
                    Background="#F39C12"
                    Foreground="White"
                    BorderThickness="0"
                    FontWeight="Bold"
                    Cursor="Hand"
                    Command="{Binding AddPasswordFromRightCommand}" Click="Button_Click">
                        <Button.Template>
                            <ControlTemplate TargetType="Button">
                                <Border Background="{TemplateBinding Background}" CornerRadius="6" Padding="{TemplateBinding Padding}">
                                    <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                </Border>
                            </ControlTemplate>
                        </Button.Template>
                    </Button>
                </DockPanel>

                <!-- Corps avec ascenseur -->
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel>

                        <!-- Message si liste vide -->
                        <TextBlock Text="Aucun mot de passe pour ce client."
                           Foreground="#7F8C8D" Margin="0,0,0,10">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding PasswordEntries.Count}" Value="0">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>

                        <!-- Liste des mots de passe -->
                        <ItemsControl x:Name="PasswordsList" ItemsSource="{Binding PasswordEntries}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Padding="10" Margin="0,0,0,10"
              Background="#FFFFFF" CornerRadius="8"
              BorderBrush="#ECECEC" BorderThickness="1"
              Tag="{Binding DataContext, ElementName=Root}">
                                        <!-- Menu contextuel : DataContext = ViewModel, Paramètre = item (FileModel) -->
                                        <Border.ContextMenu>
                                            <ContextMenu DataContext="{Binding PlacementTarget.Tag, RelativeSource={RelativeSource Self}}">
                                                <!-- Modifier -->
                                                <MenuItem Header="Modifier"
                      Command="{Binding EditPasswordCommand}"
                      CommandParameter="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource AncestorType=ContextMenu}}">
                                                    <MenuItem.Icon>
                                                        <Path Data="M20,6 18,4 4,18 4,22 8,22Z"
                      Fill="#F39C12" Stretch="Uniform" Width="16" Height="16"/>
                                                    </MenuItem.Icon>
                                                </MenuItem>

                                                <!-- Monter -->
                                                <MenuItem Header="Monter" Click="MoveUpContextMenu_Click" Style="{StaticResource ContextMenuItemStyle}">
                                                    <MenuItem.Icon>
                                                        <Path Data="M7,15 L12,10 L17,15" Stroke="#3498DB" StrokeThickness="2"
              StrokeEndLineCap="Round" StrokeStartLineCap="Round"/>
                                                    </MenuItem.Icon>
                                                </MenuItem>

                                                <!-- Descendre -->
                                                <MenuItem Header="Descendre" Click="MoveDownContextMenu_Click" Style="{StaticResource ContextMenuItemStyle}">
                                                    <MenuItem.Icon>
                                                        <Path Data="M7,10 L12,15 L17,10" Stroke="#3498DB" StrokeThickness="2"
              StrokeEndLineCap="Round" StrokeStartLineCap="Round"/>
                                                    </MenuItem.Icon>
                                                </MenuItem>

                                                <Separator/>

                                                <!-- Supprimer -->
                                                <MenuItem Header="Supprimer" Foreground="#E74C3C"
                      Command="{Binding DeletePasswordCommand}"
                      CommandParameter="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource AncestorType=ContextMenu}}">
                                                    <MenuItem.Icon>
                                                        <Path Data="M6,19 8,21 16,21 18,19 18,7 6,7 6,19Z M5,6 19,6 19,4 15.5,4 14.5,3 9.5,3 8.5,4 5,4Z"
                      Fill="#E74C3C" Stretch="Uniform" Width="16" Height="16"/>
                                                    </MenuItem.Icon>
                                                </MenuItem>
                                            </ContextMenu>
                                        </Border.ContextMenu>

                                        <!-- Contenu -->
                                        <StackPanel>
                                            <TextBlock Text="{Binding Name}" FontWeight="Bold" FontSize="15" Foreground="#2C3E50"/>

                                            <StackPanel Orientation="Horizontal" Margin="0,6,0,2">
                                                <TextBlock Text="Nom d'utilisateur :" FontWeight="Bold" Foreground="#34495E"/>
                                                <TextBlock Text="{Binding WindowsUsername}"
                       Margin="8,0,0,0" Foreground="#34495E"
                       Visibility="{Binding ElementName=Root, Path=DataContext.ShowCredentials, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                                <Button Content="📋" Width="28" Height="28" Margin="8,0,0,0"
                    Style="{StaticResource CopyButton}"
                    ToolTip="Copier l'utilisateur"
                    Command="{Binding ElementName=Root, Path=DataContext.CopyUsernameCommand}"
                    CommandParameter="{Binding WindowsUsername}"/>
                                            </StackPanel>

                                            <StackPanel Orientation="Horizontal" Margin="0,2,0,0">
                                                <TextBlock Text="Mot de passe :" FontWeight="Bold" Foreground="#34495E"/>
                                                <TextBlock Margin="8,0,0,0" Foreground="#34495E"
                       Visibility="{Binding ElementName=Root, Path=DataContext.ShowCredentials, Converter={StaticResource BooleanToVisibilityConverter}}">
              <Run Text="{Binding WindowsPassword, Converter={StaticResource DecryptPasswordConverter}}"/>
                                                </TextBlock>
                                                <Button Content="📋" Width="28" Height="28" Margin="8,0,0,0"
                    Style="{StaticResource CopyButton}"
                    ToolTip="Copier le mot de passe"
                    Command="{Binding ElementName=Root, Path=DataContext.CopyPasswordCommand}"
                    CommandParameter="{Binding WindowsPassword}"/>
                                            </StackPanel>
                                        </StackPanel>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>
                </ScrollViewer>
            </DockPanel>
        </Border>
        <!-- Flèches de tri (zone principale) -->
        <StackPanel Grid.Column="0" Orientation="Vertical" VerticalAlignment="Center" HorizontalAlignment="Right" Margin="10">
            <Button Content="&#x2191;" FontSize="20" Background="White" Foreground="SkyBlue" Width="40" Height="40"
             FontWeight="Bold" BorderBrush="SkyBlue" BorderThickness="2" Command="{Binding MoveUpFileCommand}" Margin="0,0,10,0"/>
            <Button Content="&#x2193;" FontSize="20" Background="White" Foreground="SkyBlue" Width="40" Height="40"
             FontWeight="Bold" BorderBrush="SkyBlue" BorderThickness="2" Command="{Binding MoveDownFileCommand}" Margin="0,0,10,0"/>
        </StackPanel>
    </Grid>
</Window>
