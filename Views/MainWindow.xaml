<Window x:Class="AccesClientWPF.Views.MainWindow"
        x:Name="Root"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:AccesClientWPF.ViewModels"
        xmlns:conv="clr-namespace:AccesClientWPF.Converters"
        Title="Accès Client 1.4.2" Height="750" Width="1300"
        Background="#EAEDED"
        WindowStartupLocation="CenterScreen">

    <Window.DataContext>
        <local:MainViewModel/>
    </Window.DataContext>

    <Window.Resources>
        <conv:FileTypeToIconConverter x:Key="FileTypeToIconConverter"/>
        <conv:StringToVisibilityConverter x:Key="StringToVisibilityConverter"/>
        <conv:NullOrEmptyToVisibilityConverter x:Key="NullOrEmptyToVisibilityConverter"/>
        <conv:DecryptPasswordConverter x:Key="DecryptPasswordConverter"/>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>

        <!-- Bouton principal arrondi -->
        <Style x:Key="RoundedButton" TargetType="Button">
            <Setter Property="Background" Value="#5DADE2"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" CornerRadius="8" Padding="10" BorderBrush="Transparent">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Bouton "copier" -->
        <Style x:Key="CopyButton" TargetType="Button">
            <Setter Property="Background" Value="#F8F9F9"/>
            <Setter Property="BorderBrush" Value="#AEB6BF"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Padding" Value="2"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" CornerRadius="3"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                BorderBrush="{TemplateBinding BorderBrush}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Items du menu contextuel -->
        <Style x:Key="ContextMenuItemStyle" TargetType="MenuItem">
            <Setter Property="Padding" Value="8,4"/>
            <Setter Property="FontSize" Value="13"/>
        </Style>
    </Window.Resources>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
            <!-- Auto : la colonne prend 0 quand le Border est Collapsed -->
            <ColumnDefinition Width="Auto"/>
        </Grid.ColumnDefinitions>

        <!-- Colonne gauche (clients + contenu principal) -->
        <DockPanel Grid.Column="0">
            <Border DockPanel.Dock="Left" Background="#34495E" Padding="10" CornerRadius="8">
                <DockPanel Width="220">
                    <TextBlock Text="Clients" FontSize="18" FontWeight="Bold" Foreground="White" Margin="5" DockPanel.Dock="Top"/>

                    <StackPanel DockPanel.Dock="Bottom">
                        <Button Content="Gérer les clients" Command="{Binding ManageClientsCommand}"
                                Margin="10,5" Height="45" Style="{StaticResource RoundedButton}"/>
                        <Button Content="Extranet" Command="{Binding OpenExtranetCommand}"
                                Margin="10,5" Height="45" Style="{StaticResource RoundedButton}"/>
                        <Button Content="Aide en ligne" Command="{Binding OpenOnlineHelpCommand}"
                                Margin="10,5" Height="45" Style="{StaticResource RoundedButton}"/>
                        <Button Content="Gestion base partagée" Command="{Binding ManageSharedDatabaseCommand}"
                                Margin="10,5,10,10" Height="45" Style="{StaticResource RoundedButton}"/>
                    </StackPanel>

                    <ListBox ItemsSource="{Binding Clients}" DisplayMemberPath="Name"
                             SelectedItem="{Binding SelectedClient, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                             Background="#D5DBDB" BorderThickness="0" Padding="5" Margin="0,5"
                             VerticalAlignment="Stretch" ScrollViewer.VerticalScrollBarVisibility="Auto"/>
                </DockPanel>
            </Border>

            <!-- Contenu principal -->
            <ScrollViewer x:Name="MainScrollViewer" VerticalScrollBarVisibility="Auto" PreviewMouseWheel="MainScrollViewer_PreviewMouseWheel">
                <StackPanel>
                    <!-- Options -->
                    <StackPanel Orientation="Horizontal" Margin="10">
                        <CheckBox Content="Activer le mode multi-moniteur"
                                  Margin="0,0,20,0"
                                  IsChecked="{Binding IsMultiMonitor, Mode=TwoWay}"/>
                        <CheckBox Content="Afficher les identifiants"
                                  IsChecked="{Binding ShowCredentials, Mode=TwoWay}"/>
                    </StackPanel>

                    <!-- Bandeau client + Ajouter -->
                    <Border Background="#34495E" Margin="10,5,10,10" Padding="15,10" CornerRadius="8">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <TextBlock Grid.Column="0" Text="{Binding SelectedClient.Name}"
                                       FontSize="20" FontWeight="Bold" Foreground="White"
                                       HorizontalAlignment="Center"/>

                            <Button Grid.Column="1"
                                    Content="+ Ajouter"
                                    Style="{StaticResource RoundedButton}"
                                    Background="#2ECC71"
                                    Foreground="White"
                                    Padding="8,3"
                                    Margin="5,0,10,0"
                                    Command="{Binding AddFileCommand}"/>
                        </Grid>
                    </Border>

                    <!-- Liste du centre (on masque MotDePasse ici) -->
                    <ListView Name="FileList"
                              ItemsSource="{Binding FilteredFiles}"
                              SelectedItem="{Binding SelectedFile, Mode=TwoWay}"
                              MouseDoubleClick="FileList_MouseDoubleClick"
                              Background="Transparent" BorderThickness="0"
                              ScrollViewer.VerticalScrollBarVisibility="Disabled">

                        <ListView.ItemContainerStyle>
                            <Style TargetType="ListViewItem">
                                <Setter Property="Visibility" Value="Visible"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding Type}" Value="MotDePasse">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </ListView.ItemContainerStyle>

                        <ListView.ContextMenu>
                            <ContextMenu>
                                <MenuItem Header="Ajouter un élément" Click="AddContextMenu_Click" Style="{StaticResource ContextMenuItemStyle}">
                                    <MenuItem.Icon>
                                        <Path Data="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z" Fill="#2ECC71" Stretch="Uniform" Width="16" Height="16"/>
                                    </MenuItem.Icon>
                                </MenuItem>
                                <MenuItem Header="Modifier cet élément" Click="EditContextMenu_Click" Style="{StaticResource ContextMenuItemStyle}">
                                    <MenuItem.Icon>
                                        <Path Data="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z" Fill="#F39C12" Stretch="Uniform" Width="16" Height="16"/>
                                    </MenuItem.Icon>
                                </MenuItem>
                                <MenuItem Header="Supprimer cet élément" Click="DeleteContextMenu_Click" Style="{StaticResource ContextMenuItemStyle}">
                                    <MenuItem.Icon>
                                        <Path Data="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z" Fill="#E74C3C" Stretch="Uniform" Width="16" Height="16"/>
                                    </MenuItem.Icon>
                                </MenuItem>
                            </ContextMenu>
                        </ListView.ContextMenu>

                        <ListView.ItemTemplate>
                            <DataTemplate>
                                <Border CornerRadius="10" Background="#FDFEFE" Padding="10" Margin="5">
                                    <StackPanel>
                                        <!-- Ligne principale -->
                                        <Grid Width="600">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="80"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>

                                            <Border Grid.Column="0" Background="#EAEDED" Padding="5" CornerRadius="8" Margin="0,0,15,0" Width="70" Height="70">
                                                <Image Width="56" Height="56" RenderOptions.BitmapScalingMode="HighQuality">
                                                    <Image.Source>
                                                        <Binding Path="." Converter="{StaticResource FileTypeToIconConverter}"/>
                                                    </Image.Source>
                                                </Image>
                                            </Border>

                                            <TextBlock Grid.Column="1" Text="{Binding Name}" VerticalAlignment="Center"
                                                       FontSize="16" FontWeight="Bold" Foreground="#2C3E50"/>

                                            <TextBlock Grid.Column="2" Text="{Binding Type}" VerticalAlignment="Center"
                                                       FontSize="13" Foreground="#7F8C8D" Margin="10,0,0,0"/>
                                        </Grid>

                                        <!-- Infos Windows pour AnyDesk -->
                                        <Grid Visibility="{Binding Type, Converter={StaticResource StringToVisibilityConverter}, ConverterParameter=AnyDesk}"
                                              Margin="80,5,0,0">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>

                                            <!-- Utilisateur -->
                                            <StackPanel Grid.Column="0" Orientation="Horizontal"
            Visibility="{Binding WindowsUsername, Converter={StaticResource NullOrEmptyToVisibilityConverter}}">
                                                <TextBlock Text="Utilisateur Windows:" VerticalAlignment="Center"
               FontSize="12" FontWeight="Bold" Foreground="#34495E"/>
                                                <TextBlock Text="{Binding WindowsUsername}" VerticalAlignment="Center"
               FontSize="12" Foreground="#34495E" Margin="5,0,5,0"
               Visibility="{Binding DataContext.ShowCredentials,
                                    RelativeSource={RelativeSource AncestorType=Window},
                                    Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                                <Button Content="📋" Width="25" Height="25" Margin="2"
            ToolTip="Copier le nom d'utilisateur"
            Command="{Binding DataContext.CopyUsernameCommand, RelativeSource={RelativeSource AncestorType=Window}}"
            CommandParameter="{Binding WindowsUsername}"
            Style="{StaticResource CopyButton}"/>
                                            </StackPanel>

                                            <!-- Mot de passe -->
                                            <StackPanel Grid.Column="2" Orientation="Horizontal" Margin="15,0,0,0"
            Visibility="{Binding WindowsPassword, Converter={StaticResource NullOrEmptyToVisibilityConverter}}">
                                                <TextBlock Text="Mot de passe Windows:" VerticalAlignment="Center"
               FontSize="12" FontWeight="Bold" Foreground="#34495E"/>
                                                <TextBlock VerticalAlignment="Center"
               FontSize="12" Foreground="#34495E" Margin="5,0,5,0"
               Visibility="{Binding DataContext.ShowCredentials,
                                    RelativeSource={RelativeSource AncestorType=Window},
                                    Converter={StaticResource BooleanToVisibilityConverter}}">
        <Run Text="{Binding WindowsPassword, Converter={StaticResource DecryptPasswordConverter}, Mode=OneWay}"/>
                                                </TextBlock>
                                                <Button Content="📋" Width="25" Height="25" Margin="5,0,0,0"
            ToolTip="Copier le mot de passe"
            Command="{Binding DataContext.CopyPasswordCommand, RelativeSource={RelativeSource AncestorType=Window}}"
            CommandParameter="{Binding WindowsPassword}"
            Style="{StaticResource CopyButton}"/>
                                            </StackPanel>

                                        </Grid>
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                    </ListView>
                </StackPanel>
            </ScrollViewer>
        </DockPanel>

        <!-- Colonne de droite : Mots de passe supplémentaires -->
        <Grid Grid.Column="1">
            <Border x:Name="RightPanel"
                    Background="#FDF6E3"
                    BorderBrush="#D5DBDB"
                    BorderThickness="1"
                    CornerRadius="12"
                    Padding="20"
                    Margin="15,20,15,20">
                <!-- Masquer si aucun mot de passe -->
                <Border.Style>
                    <Style TargetType="Border">
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding PasswordEntries.Count}" Value="0">
                                <Setter Property="Visibility" Value="Collapsed"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Border.Style>

                <DockPanel LastChildFill="True">
                    <!-- En-tête -->
                    <DockPanel DockPanel.Dock="Top" LastChildFill="False" Margin="0,0,0,12">
                        <TextBlock Text="Mots de passe supplémentaires"
                                   FontSize="18" FontWeight="Bold" Foreground="#34495E"
                                   VerticalAlignment="Center"/>
                        <Button Content="+ Ajouter"
                                Margin="12,0,0,0"
                                Padding="10,4"
                                Background="#F39C12"
                                Foreground="White"
                                BorderThickness="0"
                                FontWeight="Bold"
                                Cursor="Hand"
                                Command="{Binding AddPasswordFromRightCommand}">
                            <Button.Template>
                                <ControlTemplate TargetType="Button">
                                    <Border Background="{TemplateBinding Background}" CornerRadius="6" Padding="{TemplateBinding Padding}">
                                        <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                    </Border>
                                </ControlTemplate>
                            </Button.Template>
                        </Button>
                    </DockPanel>

                    <!-- Liste des mots de passe avec ascenseur vertical -->
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <ItemsControl x:Name="PasswordsList" ItemsSource="{Binding PasswordEntries}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <!-- Tag = ViewModel pour câbler le ContextMenu -->
                                    <Border Padding="10" Margin="0,0,0,10"
                                            Background="#FFFFFF" CornerRadius="8"
                                            BorderBrush="#ECECEC" BorderThickness="1"
                                            Tag="{Binding DataContext, ElementName=Root}">

                                        <!-- Menu contextuel (MODIFIER / MONTER / DESCENDRE / SUPPRIMER) -->
                                        <Border.ContextMenu>
                                            <!-- IMPORTANT : DataContext = l’item (FileModel) cliqué -->
                                            <ContextMenu DataContext="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource Self}}">
                                                <!-- Modifier -->
                                                <MenuItem Header="Modifier"
                                                          Style="{StaticResource ContextMenuItemStyle}"
                                                          Command="{Binding PlacementTarget.Tag.EditPasswordCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                                          CommandParameter="{Binding}">
                                                    <MenuItem.Icon>
                                                        <Path Data="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z"
                                                              Fill="#F39C12" Stretch="Uniform" Width="16" Height="16"/>
                                                    </MenuItem.Icon>
                                                </MenuItem>

                                                <!-- Monter -->
                                                <MenuItem Header="Monter"
                                                          Style="{StaticResource ContextMenuItemStyle}"
                                                          Command="{Binding PlacementTarget.Tag.MovePasswordUpCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                                          CommandParameter="{Binding}">
                                                    <MenuItem.Icon>
                                                        <Path Data="M7,15L12,10L17,15H7Z"
                                                              Fill="#3498DB" Stretch="Uniform" Width="16" Height="16"/>
                                                    </MenuItem.Icon>
                                                </MenuItem>

                                                <!-- Descendre -->
                                                <MenuItem Header="Descendre"
                                                          Style="{StaticResource ContextMenuItemStyle}"
                                                          Command="{Binding PlacementTarget.Tag.MovePasswordDownCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                                          CommandParameter="{Binding}">
                                                    <MenuItem.Icon>
                                                        <Path Data="M7,10L12,15L17,10H7Z"
                                                              Fill="#3498DB" Stretch="Uniform" Width="16" Height="16"/>
                                                    </MenuItem.Icon>
                                                </MenuItem>

                                                <Separator/>

                                                <!-- Supprimer -->
                                                <MenuItem Header="Supprimer"
                                                          Style="{StaticResource ContextMenuItemStyle}"
                                                          Foreground="#E74C3C"
                                                          Command="{Binding PlacementTarget.Tag.DeletePasswordCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                                          CommandParameter="{Binding}">
                                                    <MenuItem.Icon>
                                                        <Path Data="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"
                                                              Fill="#E74C3C" Stretch="Uniform" Width="16" Height="16"/>
                                                    </MenuItem.Icon>
                                                </MenuItem>
                                            </ContextMenu>
                                        </Border.ContextMenu>

                                        <!-- Contenu d’un mot de passe -->
                                        <StackPanel>
                                            <!-- Nom -->
                                            <TextBlock Text="{Binding Name}"
                                                       FontWeight="Bold" FontSize="15" Foreground="#2C3E50"/>

                                            <!-- Utilisateur -->
                                            <StackPanel Orientation="Horizontal" Margin="0,6,0,2">
                                                <TextBlock Text="Nom d'utilisateur :" FontWeight="Bold" Foreground="#34495E"/>
                                                <TextBlock Text="{Binding WindowsUsername}"
                                                           Margin="8,0,0,0" Foreground="#34495E"
                                                           Visibility="{Binding ElementName=Root, Path=DataContext.ShowCredentials, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                                <Button Content="📋"
                                                        Width="28" Height="28" Margin="8,0,0,0"
                                                        Style="{StaticResource CopyButton}"
                                                        ToolTip="Copier l'utilisateur"
                                                        Command="{Binding ElementName=Root, Path=DataContext.CopyUsernameCommand}"
                                                        CommandParameter="{Binding WindowsUsername}"/>
                                            </StackPanel>

                                            <!-- Mot de passe -->
                                            <StackPanel Orientation="Horizontal" Margin="0,2,0,0">
                                                <TextBlock Text="Mot de passe :" FontWeight="Bold" Foreground="#34495E"/>
                                                <TextBlock Margin="8,0,0,0" Foreground="#34495E"
                                                           Visibility="{Binding ElementName=Root, Path=DataContext.ShowCredentials, Converter={StaticResource BooleanToVisibilityConverter}}">
                                                    <Run Text="{Binding WindowsPassword, Converter={StaticResource DecryptPasswordConverter}}"/>
                                                </TextBlock>
                                                <Button Content="📋"
                                                        Width="28" Height="28" Margin="8,0,0,0"
                                                        Style="{StaticResource CopyButton}"
                                                        ToolTip="Copier le mot de passe"
                                                        Command="{Binding ElementName=Root, Path=DataContext.CopyPasswordCommand}"
                                                        CommandParameter="{Binding WindowsPassword}"/>
                                            </StackPanel>
                                        </StackPanel>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </DockPanel>
            </Border>
        </Grid>

        <!-- Toast de confirmation de copie -->
        <Border x:Name="CopyToast"
Background="#323232"
CornerRadius="6"
Padding="10"
HorizontalAlignment="Right"
VerticalAlignment="Top"
Margin="0,15,15,0"
Opacity="0.95"
Visibility="{Binding IsCopyToastVisible, Converter={StaticResource BooleanToVisibilityConverter}}">
            <TextBlock Text="{Binding CopyToastText}"
       Foreground="White"
       FontWeight="SemiBold" />
        </Border>

        <!-- Flèches de tri (zone principale) -->
        <StackPanel Grid.Column="0" Orientation="Vertical" VerticalAlignment="Center" HorizontalAlignment="Right" Margin="10">
            <Button Content="&#x2191;" FontSize="20" Background="White" Foreground="SkyBlue" Width="40" Height="40"
                    FontWeight="Bold" BorderBrush="SkyBlue" BorderThickness="2" Command="{Binding MoveUpFileCommand}" Margin="0,0,10,0"/>
            <Button Content="&#x2193;" FontSize="20" Background="White" Foreground="SkyBlue" Width="40" Height="40"
                    FontWeight="Bold" BorderBrush="SkyBlue" BorderThickness="2" Command="{Binding MoveDownFileCommand}" Margin="0,0,10,0"/>
        </StackPanel>
    </Grid>
</Window>
